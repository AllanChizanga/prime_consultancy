{% extends 'main/base.html' %}
{% load crispy_forms_tags %}

{% block title %}ZIMRA Compliance Dashboard{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-12">
      <h1 class="mb-4">
        <i class="bi bi-graph-up-arrow"></i> ZIMRA Compliance Dashboard
      </h1>
      
      <!-- Summary Cards -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card bg-success text-white">
            <div class="card-body">
              <h5 class="card-title"><i class="bi bi-check-circle"></i> Submitted</h5>
              <h2>{{ stats.submitted }}</h2>
              <p class="card-text">Successfully submitted to ZIMRA</p>
            </div>
          </div>
        </div>
        
        <div class="col-md-3">
          <div class="card bg-warning text-white">
            <div class="card-body">
              <h5 class="card-title"><i class="bi bi-clock"></i> Pending</h5>
              <h2>{{ stats.pending }}</h2>
              <p class="card-text">Awaiting submission</p>
            </div>
          </div>
        </div>
        
        <div class="col-md-3">
          <div class="card bg-danger text-white">
            <div class="card-body">
              <h5 class="card-title"><i class="bi bi-x-circle"></i> Failed</h5>
              <h2>{{ stats.failed }}</h2>
              <p class="card-text">Submission failures</p>
            </div>
          </div>
        </div>
        
        <div class="col-md-3">
          <div class="card bg-info text-white">
            <div class="card-body">
              <h5 class="card-title"><i class="bi bi-arrow-repeat"></i> Retry Queue</h5>
              <h2>{{ stats.retry }}</h2>
              <p class="card-text">Queued for retry</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Actions -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
              <div class="btn-group" role="group">
                <button type="button" class="btn btn-primary" onclick="retryFailedSubmissions()">
                  <i class="bi bi-arrow-repeat"></i> Retry Failed Submissions
                </button>
                <button type="button" class="btn btn-info" onclick="refreshStatus()">
                  <i class="bi bi-arrow-clockwise"></i> Refresh Status
                </button>
                <button type="button" class="btn btn-secondary" onclick="exportReport()">
                  <i class="bi bi-download"></i> Export Report
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Recent Submissions -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Recent Submissions</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Receipt #</th>
                  <th>Submission Time</th>
                  <th>Status</th>
                  <th>ZIMRA Response</th>
                  <th>Retry Count</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for log in recent_logs %}
                <tr>
                  <td>
                    <strong>{{ log.receipt.invoice_number }}</strong><br>
                    <small class="text-muted">${{ log.receipt.total }}</small>
                  </td>
                  <td>{{ log.submission_timestamp|date:"M d, Y H:i" }}</td>
                  <td>
                    {% if log.submission_status == 'SUBMITTED' %}
                      <span class="badge bg-success">{{ log.submission_status }}</span>
                    {% elif log.submission_status == 'PENDING' %}
                      <span class="badge bg-warning">{{ log.submission_status }}</span>
                    {% elif log.submission_status == 'FAILED' %}
                      <span class="badge bg-danger">{{ log.submission_status }}</span>
                    {% elif log.submission_status == 'RETRY' %}
                      <span class="badge bg-info">{{ log.submission_status }}</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if log.zimra_receipt_number %}
                      <strong>{{ log.zimra_receipt_number }}</strong>
                    {% elif log.error_message %}
                      <span class="text-danger">{{ log.error_message|truncatechars:50 }}</span>
                    {% else %}
                      <span class="text-muted">No response</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if log.retry_count > 0 %}
                      <span class="badge bg-secondary">{{ log.retry_count }}</span>
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td>
                    {% if log.submission_status == 'FAILED' or log.submission_status == 'RETRY' %}
                      <button class="btn btn-sm btn-outline-primary" onclick="retrySubmission({{ log.receipt.id }})">
                        <i class="bi bi-arrow-repeat"></i> Retry
                      </button>
                    {% endif %}
                    <button class="btn btn-sm btn-outline-info" onclick="viewDetails({{ log.id }})">
                      <i class="bi bi-eye"></i> Details
                    </button>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="6" class="text-center text-muted py-4">
                    No submission logs found
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function retryFailedSubmissions() {
  if (confirm('Retry all failed submissions?')) {
    fetch('/api/zimra/retry-failed/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      }
    })
    .then(response => response.json())
    .then(data => {
      alert(`Retry completed: ${data.successful} successful, ${data.failed} failed`);
      location.reload();
    })
    .catch(error => {
      alert('Error retrying submissions: ' + error);
    });
  }
}

function retrySubmission(receiptId) {
  if (confirm('Retry this submission?')) {
    fetch(`/api/zimra/retry-submission/${receiptId}/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Submission retry successful');
      } else {
        alert('Submission retry failed: ' + data.error);
      }
      location.reload();
    })
    .catch(error => {
      alert('Error retrying submission: ' + error);
    });
  }
}

function refreshStatus() {
  location.reload();
}

function viewDetails(logId) {
  window.open(`/zimra/submission-details/${logId}/`, '_blank');
}

function exportReport() {
  window.open('/zimra/export-report/', '_blank');
}

// Auto-refresh every 30 seconds
setInterval(function() {
  // Only refresh the summary cards, not the whole page
  fetch('/api/zimra/status-summary/')
    .then(response => response.json())
    .then(data => {
      // Update the summary cards without full page reload
      // This would require additional JavaScript to update specific elements
    });
}, 30000);
</script>
{% endblock %}
