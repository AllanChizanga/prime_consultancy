{% extends 'main/MainLayout.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-12">
      
      <!-- Messages Display -->
      {% if messages %}
      <div class="row mb-3">
        <div class="col-12">
          {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            <i class="bi bi-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-triangle{% elif message.tags == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
      
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">
          <i class="bi bi-gear-fill"></i> 
          {% if request.user.is_superuser %}
            Device Configuration - {{ user.company_name }}
          {% else %}
            My Device Configuration
          {% endif %}
        </h1>
        <div class="btn-group" role="group">
          {% if request.user.is_superuser or request.user == user %}
          <button type="button" class="btn btn-success" onclick="testConnection()">
            <i class="bi bi-wifi"></i> Test Connection
          </button>
          <button type="button" class="btn btn-warning" onclick="registerWithZimra()">
            <i class="bi bi-plus-circle"></i> Register with ZIMRA
          </button>
          <button type="button" class="btn btn-primary" onclick="syncWithZimra()">
            <i class="bi bi-arrow-repeat"></i>
            {% if request.user.is_superuser %}Sync with ZIMRA{% else %}Sync My Device{% endif %}
          </button>
          {% endif %}
        </div>
      </div>

      <!-- Setup Progress -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="bi bi-list-check"></i> Device Setup Progress
              </h5>
            </div>
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span>Setup Progress</span>
                <span class="badge bg-primary">{{ device_info.setup_progress }}%</span>
              </div>
              <div class="progress mb-3">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" 
                     aria-valuenow="{{ device_info.setup_progress }}" 
                     aria-valuemin="0" 
                     aria-valuemax="100" 
                     style="width: {{ device_info.setup_progress }}%">
                </div>
              </div>
              <div class="row text-center">
                <div class="col-3">
                  <div class="step {% if device_info.device_id %}completed{% endif %}">
                    <i class="bi bi-1-circle{% if device_info.device_id %}-fill text-success{% endif %}"></i>
                    <small class="d-block">Device ID</small>
                  </div>
                </div>
                <div class="col-3">
                  <div class="step {% if device_info.certificate_status == 'Valid' %}completed{% endif %}">
                    <i class="bi bi-2-circle{% if device_info.certificate_status == 'Valid' %}-fill text-success{% endif %}"></i>
                    <small class="d-block">Certificate</small>
                  </div>
                </div>
                <div class="col-3">
                  <div class="step {% if device_info.connection_status == 'Connected' %}completed{% endif %}">
                    <i class="bi bi-3-circle{% if device_info.connection_status == 'Connected' %}-fill text-success{% endif %}"></i>
                    <small class="d-block">Connection</small>
                  </div>
                </div>
                <div class="col-3">
                  <div class="step {% if device_info.zimra_last_sync %}completed{% endif %}">
                    <i class="bi bi-4-circle{% if device_info.zimra_last_sync %}-fill text-success{% endif %}"></i>
                    <small class="d-block">ZIMRA Sync</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Configuration Tabs -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <ul class="nav nav-tabs card-header-tabs" id="configTabs" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="device-tab" data-bs-toggle="tab" data-bs-target="#device" type="button" role="tab">
                    <i class="bi bi-router"></i> Device Settings
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="certificates-tab" data-bs-toggle="tab" data-bs-target="#certificates" type="button" role="tab">
                    <i class="bi bi-shield-check"></i> Certificates
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="zimra-tab" data-bs-toggle="tab" data-bs-target="#zimra" type="button" role="tab">
                    <i class="bi bi-cloud-arrow-up"></i> ZIMRA Integration
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="monitoring-tab" data-bs-toggle="tab" data-bs-target="#monitoring" type="button" role="tab">
                    <i class="bi bi-graph-up"></i> Monitoring
                  </button>
                </li>
              </ul>
            </div>
            
            <div class="card-body">
              <div class="tab-content" id="configTabsContent">
                
                <!-- Device Settings Tab -->
                <div class="tab-pane fade show active" id="device" role="tabpanel">
                  <div class="row">
                    <div class="col-md-6">
                      <h6 class="mb-3"><i class="bi bi-info-circle"></i> Basic Information</h6>
                      <div class="info-item">
                        <strong>Device ID:</strong>
                        <span class="text-muted">{{ device_info.device_id|default:"Not configured" }}</span>
                      </div>
                      <div class="info-item">
                        <strong>Serial Number:</strong>
                        <span class="text-muted">{{ device_info.serial_number|default:"Not configured" }}</span>
                      </div>
                      <div class="info-item">
                        <strong>Model Name:</strong>
                        <span class="text-muted">{{ device_info.model_name|default:"Not configured" }}</span>
                      </div>
                      <div class="info-item">
                        <strong>Model Version:</strong>
                        <span class="text-muted">{{ device_info.model_version|default:"Not configured" }}</span>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <h6 class="mb-3"><i class="bi bi-building"></i> Company Information</h6>
                      <div class="info-item">
                        <strong>Company Name:</strong>
                        <span class="text-muted">{{ device_info.company_name|default:"Not provided" }}</span>
                      </div>
                      <div class="info-item">
                        <strong>Tax Number:</strong>
                        <span class="text-muted">{{ device_info.tax_number|default:"Not provided" }}</span>
                      </div>
                      <div class="info-item">
                        <strong>Email:</strong>
                        <span class="text-muted">{{ device_info.email|default:"Not provided" }}</span>
                      </div>
                      <div class="info-item">
                        <strong>Phone:</strong>
                        <span class="text-muted">{{ device_info.phone|default:"Not provided" }}</span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Certificates Tab -->
                <div class="tab-pane fade" id="certificates" role="tabpanel">
                  <div class="row">
                    <div class="col-md-8">
                      <h6 class="mb-3"><i class="bi bi-shield-check"></i> Certificate Status</h6>
                      <div class="alert alert-{% if device_info.certificate_status == 'Valid' %}success{% else %}warning{% endif %}" role="alert">
                        <i class="bi bi-{% if device_info.certificate_status == 'Valid' %}check-circle{% else %}exclamation-triangle{% endif %}"></i>
                        <strong>Status:</strong> {{ device_info.certificate_status|default:"Unknown" }}
                        {% if device_info.certificate_expiry %}
                        <br><small><i class="bi bi-calendar"></i> Expires: {{ device_info.certificate_expiry|date:"Y-m-d H:i" }}</small>
                        {% endif %}
                      </div>
                      
                      {% if device_info.certificate_details %}
                      <div class="card">
                        <div class="card-header">
                          <h6 class="mb-0">Certificate Details</h6>
                        </div>
                        <div class="card-body">
                          <div class="info-item">
                            <strong>Subject:</strong>
                            <small class="text-muted">{{ device_info.certificate_details.subject }}</small>
                          </div>
                          <div class="info-item">
                            <strong>Issuer:</strong>
                            <small class="text-muted">{{ device_info.certificate_details.issuer }}</small>
                          </div>
                          <div class="info-item">
                            <strong>Serial Number:</strong>
                            <small class="text-muted">{{ device_info.certificate_details.serial_number }}</small>
                          </div>
                          <div class="info-item">
                            <strong>Valid From:</strong>
                            <small class="text-muted">{{ device_info.certificate_details.valid_from|date:"Y-m-d H:i" }}</small>
                          </div>
                          <div class="info-item">
                            <strong>Valid Until:</strong>
                            <small class="text-muted">{{ device_info.certificate_details.valid_until|date:"Y-m-d H:i" }}</small>
                          </div>
                        </div>
                      </div>
                      {% endif %}
                    </div>
                    <div class="col-md-4">
                      <h6 class="mb-3"><i class="bi bi-tools"></i> Certificate Actions</h6>
                      <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-primary" onclick="generateCSR()">
                          <i class="bi bi-file-earmark-plus"></i> Generate CSR
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="uploadCertificate()">
                          <i class="bi bi-upload"></i> Upload Certificate
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="renewCertificate()">
                          <i class="bi bi-arrow-clockwise"></i> Renew Certificate
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- ZIMRA Integration Tab -->
                <div class="tab-pane fade" id="zimra" role="tabpanel">
                  <div class="row">
                    <div class="col-md-8">
                      <h6 class="mb-3"><i class="bi bi-cloud-arrow-up"></i> ZIMRA Synchronization Status</h6>
                      
                      {% if device_info.zimra_last_sync %}
                      <div class="alert alert-success" role="alert">
                        <i class="bi bi-check-circle"></i>
                        <strong>Last Sync:</strong> {{ device_info.zimra_last_sync|date:"Y-m-d H:i:s" }}
                        <br>
                        <small><i class="bi bi-info-circle"></i> Last synced: {{ device_info.zimra_last_sync|date:"Y-m-d H:i" }}</small>
                      </div>
                      
                      <div class="row">
                        <div class="col-md-6">
                          <h6 class="mb-2">Device Information</h6>
                          <div class="info-item">
                            <strong>ZIMRA Device Status:</strong>
                            <span class="badge bg-{% if device_info.zimra_device_status == 'Active' %}success{% else %}secondary{% endif %}">
                              {{ device_info.zimra_device_status|default:"Unknown" }}
                            </span>
                          </div>
                          <div class="info-item">
                            <strong>Serial Number:</strong>
                            <span class="text-muted">{{ device_info.zimra_serial_number|default:"Not synced" }}</span>
                          </div>
                          <div class="info-item">
                            <strong>Firmware Version:</strong>
                            <span class="text-muted">{{ device_info.zimra_firmware_version|default:"Not synced" }}</span>
                          </div>
                          <div class="info-item">
                            <strong>Device Type:</strong>
                            <span class="text-muted">{{ device_info.zimra_device_type|default:"Not synced" }}</span>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <h6 class="mb-2">Fiscal Information</h6>
                          <div class="info-item">
                            <strong>Registration Status:</strong>
                            <span class="badge bg-{% if device_info.zimra_registration_status == 'Registered' %}success{% else %}warning{% endif %}">
                              {{ device_info.zimra_registration_status|default:"Not registered" }}
                            </span>
                          </div>
                          <div class="info-item">
                            <strong>Tax Period:</strong>
                            <span class="text-muted">{{ device_info.zimra_tax_period|default:"Not synced" }}</span>
                          </div>
                          <div class="info-item">
                            <strong>Last Receipt Number:</strong>
                            <span class="text-muted">{{ device_info.zimra_last_receipt_number|default:"Not synced" }}</span>
                          </div>
                        </div>
                      </div>
                      {% else %}
                      <div class="alert alert-warning" role="alert">
                        <i class="bi bi-exclamation-triangle"></i> No ZIMRA data available. Click "Sync with ZIMRA" to fetch current configuration.
                      </div>
                      {% endif %}
                    </div>
                    <div class="col-md-4">
                      <h6 class="mb-3"><i class="bi bi-gear"></i> ZIMRA Actions</h6>
                      <div class="d-grid gap-2">
                        <button type="button" class="btn btn-warning" onclick="registerWithZimra()">
                          <i class="bi bi-plus-circle"></i> Register Device
                        </button>
                        <button type="button" class="btn btn-success" onclick="testConnection()">
                          <i class="bi bi-wifi"></i> Test Connection
                        </button>
                        <button type="button" class="btn btn-primary" onclick="syncWithZimra()">
                          <i class="bi bi-arrow-repeat"></i> Sync Now
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Monitoring Tab -->
                <div class="tab-pane fade" id="monitoring" role="tabpanel">
                  <div class="row">
                    <div class="col-md-6">
                      <h6 class="mb-3"><i class="bi bi-activity"></i> Connection Status</h6>
                      <div class="card">
                        <div class="card-body">
                          <div class="d-flex justify-content-between align-items-center">
                            <span>Status:</span>
                            <span class="badge bg-{% if device_info.connection_status == 'Connected' %}success{% elif device_info.connection_status == 'Error' %}danger{% else %}secondary{% endif %}">
                              {{ device_info.connection_status|default:"Unknown" }}
                            </span>
                          </div>
                          {% if device_info.last_test %}
                          <hr>
                          <small class="text-muted">
                            <i class="bi bi-clock"></i> Last tested: {{ device_info.last_test|date:"Y-m-d H:i:s" }}
                          </small>
                          {% if device_info.response_time %}
                          <br>
                          <small class="text-muted">
                            <i class="bi bi-speedometer2"></i> Response time: {{ device_info.response_time|floatformat:3 }}s
                          </small>
                          {% endif %}
                          {% endif %}
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <h6 class="mb-3"><i class="bi bi-bar-chart"></i> Usage Statistics</h6>
                      <div class="card">
                        <div class="card-body">
                          <div class="info-item">
                            <strong>Total Receipts:</strong>
                            <span class="text-muted">{{ device_info.total_receipts|default:"0" }}</span>
                          </div>
                          <div class="info-item">
                            <strong>Last Receipt:</strong>
                            <span class="text-muted">{{ device_info.last_receipt_date|date:"Y-m-d H:i"|default:"None" }}</span>
                          </div>
                          <div class="info-item">
                            <strong>Success Rate:</strong>
                            <span class="text-muted">{{ device_info.success_rate|default:"N/A" }}%</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Test Connection Form (Hidden) -->
<form id="testConnectionForm" method="post" style="display: none;">
  {% csrf_token %}
  <input type="hidden" name="action" value="test_connection">
</form>

<!-- Sync with ZIMRA Form (Hidden) -->
<form id="syncZimraForm" method="post" style="display: none;">
  {% csrf_token %}
  <input type="hidden" name="action" value="sync_with_zimra">
</form>

<!-- Register with ZIMRA Form (Hidden) -->
<form id="registerZimraForm" method="post" style="display: none;">
  {% csrf_token %}
  <input type="hidden" name="action" value="register_with_zimra">
</form>

<script>
function testConnection() {
  if (confirm('Test connection to ZIMRA API?')) {
    console.log('Submitting test connection form');
    document.getElementById('testConnectionForm').submit();
  }
}

function registerWithZimra() {
  if (confirm('Register this device with ZIMRA? This is required before you can sync or test connections.')) {
    console.log('Submitting register ZIMRA form');
    document.getElementById('registerZimraForm').submit();
  }
}

function syncWithZimra() {
  if (confirm('Synchronize device configuration with ZIMRA? This may take a few moments.')) {
    console.log('Submitting sync form');
    document.getElementById('syncZimraForm').submit();
  }
}

function generateCSR() {
  alert('CSR generation feature will be implemented');
}

function uploadCertificate() {
  alert('Certificate upload feature will be implemented');
}

function renewCertificate() {
  alert('Certificate renewal feature will be implemented');
}

// Auto-refresh connection status every 30 seconds
setInterval(function() {
  // Optional: Add AJAX call to refresh connection status
}, 30000);
</script>

{% endblock content %}
